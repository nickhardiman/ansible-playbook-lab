# Build the virtual machine hardware, install OS, and install apps.
#
#
# prerequisites 
# git, the hypervisor, Ansible user, image storage and virtual network.
# A bootstrap shell script sets these up.
# See instructions in the README and machine-hypervisor.sh
#
# Each of these playbooks can be run separately. 
# For machines that need to register with RHSM, use a vault file.
#   ansible-playbook --vault-pass-file=~/my-vault-pass  machine-repo.yml
# For machines that use local repos, there is no need to register.
#   ansible-playbook  machine-git.yml
#
# Work around some chicken-and-egg problems. 
# * No DHCP yet, so the first two machines have static IP addresses.
# * No DNS yet, so the first three have /etc/hosts records. 
# * No local RPM repositories yet, so the first four update from RHSM CDN 
#   (Red Hat Subscription Management Content Delivery Network). 
#   An account is required for registering with RHSM.
# Work around some access problems.
# * No NAT, so the first four machines need to use the gateway proxy.
# * The install host does not use the new network's DNS. 
#   Add /etc/hosts records so the install host can find all these machines.
#
# Gateway has a unique architecture. 
# It is the only host with an interface on the public network and 
# a second interface on the lab network.
# It runs squid to proxy web requests to the Internet, and 
# bind to proxy DNS requests to the Internet. 



# !!!
# - ansible.builtin.import_playbook: image-gateway.yml
# - ansible.builtin.import_playbook: machine-gateway.yml
# - ansible.builtin.import_playbook: image-ipsal.yml
# - ansible.builtin.import_playbook: machine-ipsal.yml
# # DHCP is now available. 
# # Interfaces can now get info from DHCP.
# - ansible.builtin.import_playbook: image-id.yml
# - ansible.builtin.import_playbook: machine-id.yml
# # DNS is now available. 
# - ansible.builtin.import_playbook: image-message.yml
# - ansible.builtin.import_playbook: machine-message.yml
# This playbook installs Gitlab from a third-party site.
# It needs to use the gateway proxy to download Internet resources.
- ansible.builtin.import_playbook: image-git.yml
- ansible.builtin.import_playbook: machine-git.yml


- name: '!!! dev exit'
  hosts: hypervisor
  gather_facts: no
  tasks:
  - ansible.builtin.fail: 
# !!!




# No more need for /etc/hosts records.
# So many RPM packages to mirror! This one takes an hour.
- ansible.builtin.import_playbook: machine-repo.yml
# Local RPM repositories are now available. 
# OS can now install and update packages from local repos.
# This playbook installs Gitlab from a third-party site.
# It needs to use the gateway proxy to download Internet resources.
- ansible.builtin.import_playbook: machine-git.yml
# This playbook installs Elastic stack, which needs to use the gateway proxy to download Internet resources.
- ansible.builtin.import_playbook: machine-log.yml
# This playbook installs prometheus and grafana, which needs to use the gateway proxy to download Internet resources.
- ansible.builtin.import_playbook: machine-metric.yml

# test the new stack
- ansible.builtin.import_playbook: test-stack.yml

